MISSION_ID: SMOOTHING_RENDERING_STABILITY_V2

TITLE
Eliminate smoothing-change rendering glitches via generation gating, path invalidation, and NaN/size guards (render-only stability)

GOAL
When changing smoothing:
- No partial curves
- No vertical-drop artifacts
- No stale traces lingering
- No one-frame garbage when buffers are resizing/rebuilding
This must work across FFT sizes and all traces (Stereo/L/R/Mono/Mid/Side/RMS/Peak).

HARD RULES
- No audio-thread changes.
- No allocations in paint().
- Minimal diffs.
- Do NOT change smoothing math, FFT math, peak hold, ballistics, or weighting.
- Fix is stability plumbing only: state, guards, path rebuild rules.

FILES ALLOWED
- Source/ui/analyzer/AnalyzerDisplayView.cpp (if smoothing param is observed here)
- Source/ui/analyzer/RTADisplay.cpp
- Source/ui/analyzer/RTADisplay.h (only if needed for small state members)

FILES FORBIDDEN
- AnalyzerEngine.*
- AnalyzerSnapshot.*
- PluginProcessor.*
- Any DSP/FFT compute code

============================================================
IMPLEMENTER PROMPT
============================================================

ROLE
You are Antigravity. You are fixing render stability only.

STEP 1 — Add “generation counters” (atomicity)
In the UI layer that owns:
- trace buffers (db arrays)
- smoothing selection (octave setting)
Add 2 uint32 counters:

A) traceDataGen_   // increments when any trace buffer content changes in a way that affects rendering
B) smoothingGen_   // increments when smoothing param value changes

Rules:
- traceDataGen_ increments when:
  - numBins changes
  - new snapshot frame is ingested (new raw L/R etc)
  - any derived trace arrays are rebuilt
- smoothingGen_ increments ONLY when smoothing selection changes

STOP and report:
- where you store these and when each increments

STEP 2 — Track per-Path build generations
In RTADisplay (or the class that caches built Paths), add:
- uint32 lastPathTraceDataGen_ = 0;
- uint32 lastPathSmoothingGen_ = 0;
- bool pathsValid_ = false;

Rule:
Paths are valid only if:
- lastPathTraceDataGen_ == traceDataGen_
- lastPathSmoothingGen_ == smoothingGen_
- and all enabled traces have matching bins sizes

STOP and report new members

STEP 3 — Centralize “invalidatePaths()”
Add a method:
invalidatePaths()
that sets:
- pathsValid_ = false

Call invalidatePaths() when:
- smoothing changes
- numBins changes
- any trace buffer is resized
- any trace buffer is replaced (new snapshot frame)

STOP and report all call sites

STEP 4 — Build paths only in one place (outside paint), or rebuild conditionally
If you currently build paths inside paint():
- Keep it, but enforce zero allocations and only rebuild when needed.

Pattern:
if (!pathsValid_) rebuildAllPaths();

rebuildAllPaths must:
- check bins sizes match expected
- set lastPathTraceDataGen_ = traceDataGen_
- set lastPathSmoothingGen_ = smoothingGen_
- set pathsValid_ = true

If any check fails:
- pathsValid_ stays false (and paint must not draw)

STOP and report where rebuildAllPaths runs

STEP 5 — Add draw guards (critical)
In paint():
Before drawing any trace:
A) If !pathsValid_:
   - Draw nothing OR draw “NO DATA” (debug overlay only)
   - Return early (no partial draw)

B) Validate numeric safety:
During path build (NOT paint), when mapping db→y:
- if (!isfinite(db)) db = minDb
- clamp db to [minDb, maxDb]
- ensure y is finite too; if not, skip the point

C) Validate x monotonic:
Skip points where x <= lastX (prevents path self-intersections that can look like vertical lines)

STOP and report which guards were added

STEP 6 — One-frame “transition suppression” (only if needed)
If you still get a single bad frame after smoothing change:
- Add bool suppressDrawOneFrame_ flag set true when smoothing changes
- On next update tick after rebuildAllPaths succeeds, clear it
- If suppressDrawOneFrame_ is true: paint draws nothing

This is a last resort; only do it if the generation gating still produces a bad first frame.

STOP and report if you needed this

STEP 7 — DEBUG overlay (JUCE_DEBUG only)
Add an overlay line:
- bins, traceDataGen_, smoothingGen_, pathsValid_
Example:
"bins=2049 tdGen=12 smGen=5 paths=1"

This is temporary but helps us confirm stability.

STOP and report the overlay line

STEP 8 — Build + manual stress tests
Stress tests:
1) With audio running and 6+ traces enabled:
   - switch smoothing rapidly: Off → 1/24 → 1/12 → 1/3 → Off
2) Change FFT size while smoothing enabled
3) Resize window during smoothing changes

Expected:
- No broken/partial curves
- No vertical-drop artifacts
- No stale lingering curves

STOP and write:
PROMPTS/MISSIONS/IMPLEMENTER_RESULT.md
Include:
- files changed
- generation logic summary
- whether suppressDrawOneFrame_ was needed
- tests performed + result
End with STOP

============================================================
VERIFIER PROMPT
============================================================

ROLE
You are Antigravity. Verify atomic rendering across smoothing changes.

CHECK 1 — Scope lock
PASS only if modified files are within allowed scope.

CHECK 2 — Generations + invalidation
PASS if:
- smoothing change increments smoothingGen_
- trace buffer change increments traceDataGen_
- invalidatePaths called appropriately
- pathsValid_ only true when gens match

FAIL if:
- paint can draw with mismatched gens

CHECK 3 — No allocations in paint
PASS if:
- no vector resize/new allocations in paint
- rebuild uses preallocated buffers or resizes only on bin count change outside paint

CHECK 4 — Runtime stress
A) Rapid smoothing switching with audio + multiple traces
PASS if: no partial/vertical artifacts

B) FFT size change with smoothing enabled
PASS if: no artifacts and paths rebuild cleanly

C) Window resize during switching
PASS if: stable

CHECK 5 — Debug overlay sanity (JUCE_DEBUG)
PASS if overlay reflects:
- tdGen and smGen incrementing
- pathsValid toggling false then true
No stuck false.

OUTPUT
Write PROMPTS/MISSIONS/VERIFIER_RESULT.md with:
| Check | Status | Notes |
| Scope | PASS/FAIL | |
| Gen gating | PASS/FAIL | |
| Paint allocation | PASS/FAIL | |
| Stress switch | PASS/FAIL | |
| FFT resize | PASS/FAIL | |
| Resize | PASS/FAIL | |

End with STOP